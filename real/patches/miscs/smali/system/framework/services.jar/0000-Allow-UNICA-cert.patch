From adf0edded2252356dfdea3d1df6137ababd0dc90 Mon Sep 17 00:00:00 2001
From: BlackMesa123 <giangrecosalvo9@gmail.com>
Date: Wed, 29 Nov 2023 12:26:54 +0100
Subject: [PATCH] Allow custom platform signature

Based off: https://github.com/ArrowOS/android_frameworks_base/commit/bf54af6bfbc9110e6a6586d39b0c35fec1f051c1
---
 .../server/pm/InstallPackageHelper.smali      |  94 ++++++-
 .../android/server/pm/ScanPackageUtils.smali  | 242 +++++++++++-------
 2 files changed, 233 insertions(+), 103 deletions(-)

diff --git a/smali_classes3/com/android/server/pm/InstallPackageHelper.smali b/smali_classes3/com/android/server/pm/InstallPackageHelper.smali
index 609f79ad..77b3fc0b 100644
--- a/smali_classes3/com/android/server/pm/InstallPackageHelper.smali
+++ b/smali_classes3/com/android/server/pm/InstallPackageHelper.smali
@@ -54,6 +54,8 @@
 
 .field public final mUpdateOwnershipHelper:Lcom/android/server/pm/UpdateOwnershipHelper;
 
+.field public mCustomPlatformSignatures:[Landroid/content/pm/Signature;
+
 .field public final mViewCompiler:Lcom/android/server/pm/dex/ViewCompiler;
 
 
@@ -147,6 +149,12 @@
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
+    const/4 v0, 0x0
+
+    new-array v0, v0, [Landroid/content/pm/Signature;
+
+    iput-object v0, p0, Lcom/android/server/pm/InstallPackageHelper;->mCustomPlatformSignatures:[Landroid/content/pm/Signature;
+
     new-instance v0, Lcom/samsung/android/server/pm/install/PreloadDuplicateApps;
 
     invoke-direct {v0}, Lcom/samsung/android/server/pm/install/PreloadDuplicateApps;-><init>()V
@@ -269,6 +277,22 @@
 
     iput-object p1, p0, Lcom/android/server/pm/InstallPackageHelper;->mUpdateOwnershipHelper:Lcom/android/server/pm/UpdateOwnershipHelper;
 
+    const/4 p1, 0x1
+
+    new-array p1, p1, [Ljava/lang/String;
+
+    const/4 v0, 0x0
+
+    const-string v1, "308203c7308202afa00302010202140fd6534d42431698c5c840fe189e90d3ff171aa9300d06092a864886f70d01010b05003072310b3009060355040613024954310f300d06035504080c064974616c6961310f300d06035504070c06546f72696e6f3111300f060355040a0c08466564654c6162733110300e060355040b0c075265616c524f4d311c301a06035504030c135265616c524f4d205369676e696e67204b65793020170d3234313032313135343733355a180f32303532303330383135343733355a3072310b3009060355040613024954310f300d06035504080c064974616c6961310f300d06035504070c06546f72696e6f3111300f060355040a0c08466564654c6162733110300e060355040b0c075265616c524f4d311c301a06035504030c135265616c524f4d205369676e696e67204b657930820122300d06092a864886f70d01010105000382010f003082010a0282010100bf261801a2ca2650f529dd489bcd77fda247eae3b3c4564508cd9614f1b21e911a458d339bd1f71e19dff3e0b05e3daa53eb3f57b06e518a8fb1a2c5c037961d7712ed8c5dc9de9160d028ab08acddd45ac5d03bdaf1ef001378ca48d046c51345adbe05a97d382bca14162194c3a829852c215dbbe30eb0ba44f10ddd3cbb17edeb9b9ad2d6c1871bfa371b7787f1988dd75a932ffd45bc4d884e878e411900b75b5c1f9a2891f8eac994229dc9d7b1d28a8c0d276e574cb67185cab53cf106dce5e59b3f8141f94eee69f06ca2e60f2db236a3de58e9af3f47e324fc9f1ebf2390ace79780b6756102be73adb3bf5a02e6bebcf890a941fde83592080df5b10203010001a3533051301d0603551d0e041604148cf2d0f1bf247422613fa364595c9053ed32662e301f0603551d230418301680148cf2d0f1bf247422613fa364595c9053ed32662e300f0603551d130101ff040530030101ff300d06092a864886f70d01010b0500038201010031fe7403204bb0c385df3f617773914d9bb1b27fb54ef30b5879ee2237e7a899c50b360335edbcbfcbcd02cd47f077d3bcc55ae8e9b3d1dba374f81b73bdfb7efd0377cebbb707b798e2d341084e6ba062707e7ed62c7f7e2fbdbb51b134e7a4ec7bbee5c6f2d8bdc66ccb8f740dd7f28284a7320aa81315834a5c21709352cf4eec3cf1f68e033c8883cabd1a011331c8969074c5f0cd9a374550f7d219ff9826b6b04b7b4cdab1c6ccf1cd53c16458a88cd0bd31604bcbcb2b15555cdb8038043dc31e2744e9ba50a087291b87ba16cd330d4558c5a6dbad820f0859bf507477038572147265ba109e1027bb96930f39d92b26e00d53fbcd70ec08673e2a49"
+
+    aput-object v1, p1, v0
+
+    invoke-static {p1}, Lcom/android/server/pm/InstallPackageHelper;->createSignatures([Ljava/lang/String;)[Landroid/content/pm/Signature;
+
+    move-result-object p1
+
+    iput-object p1, p0, Lcom/android/server/pm/InstallPackageHelper;->mCustomPlatformSignatures:[Landroid/content/pm/Signature;
+
     sget-boolean p1, Lcom/samsung/android/rune/CoreRune;->SYSFW_APP_SPEG:Z
 
     if-eqz p1, :cond_0
@@ -465,6 +489,34 @@
     return p0
 .end method
 
+.method public static createSignatures([Ljava/lang/String;)[Landroid/content/pm/Signature;
+    .locals 5
+
+    array-length v0, p0
+
+    new-array v1, v0, [Landroid/content/pm/Signature;
+
+    const/4 v2, 0x0
+
+    :goto_0
+    if-ge v2, v0, :cond_0
+
+    new-instance v3, Landroid/content/pm/Signature;
+
+    aget-object v4, p0, v2
+
+    invoke-direct {v3, v4}, Landroid/content/pm/Signature;-><init>(Ljava/lang/String;)V
+
+    aput-object v3, v1, v2
+
+    add-int/lit8 v2, v2, 0x1
+
+    goto :goto_0
+
+    :cond_0
+    return-object v1
+.end method
+
 .method public static hasLauncherEntry(Lcom/android/server/pm/parsing/pkg/ParsedPackage;)Z
     .locals 6
 
@@ -20735,7 +20787,9 @@
 
     move-result-object v2
 
-    invoke-static {v7, v1, v2, v11}, Lcom/android/server/pm/ScanPackageUtils;->applyPolicy(Lcom/android/server/pm/parsing/pkg/ParsedPackage;ILcom/android/server/pm/pkg/AndroidPackage;Z)V
+    iget-object v3, v0, Lcom/android/server/pm/InstallPackageHelper;->mCustomPlatformSignatures:[Landroid/content/pm/Signature;
+
+    invoke-static {v7, v1, v2, v11, v3}, Lcom/android/server/pm/ScanPackageUtils;->applyPolicy(Lcom/android/server/pm/parsing/pkg/ParsedPackage;ILcom/android/server/pm/pkg/AndroidPackage;Z[Landroid/content/pm/Signature;)V
 
     iget-object v2, v0, Lcom/android/server/pm/InstallPackageHelper;->mPm:Lcom/android/server/pm/PackageManagerService;
 
@@ -20847,7 +20901,7 @@
 .end method
 
 .method public final scanSystemPackageLI(Lcom/android/server/pm/parsing/pkg/ParsedPackage;IILandroid/os/UserHandle;)Landroid/util/Pair;
-    .locals 27
+    .locals 28
 
     move-object/from16 v0, p0
 
@@ -21064,11 +21118,13 @@
 
     move-result-object v1
 
+    iget-object v2, v0, Lcom/android/server/pm/InstallPackageHelper;->mCustomPlatformSignatures:[Landroid/content/pm/Signature;
+
     move/from16 v7, p3
 
     const/4 v8, 0x1
 
-    invoke-static {v15, v7, v1, v8}, Lcom/android/server/pm/ScanPackageUtils;->applyPolicy(Lcom/android/server/pm/parsing/pkg/ParsedPackage;ILcom/android/server/pm/pkg/AndroidPackage;Z)V
+    invoke-static {v15, v7, v1, v8, v2}, Lcom/android/server/pm/ScanPackageUtils;->applyPolicy(Lcom/android/server/pm/parsing/pkg/ParsedPackage;ILcom/android/server/pm/pkg/AndroidPackage;Z[Landroid/content/pm/Signature;)V
 
     iget-object v1, v0, Lcom/android/server/pm/InstallPackageHelper;->mPm:Lcom/android/server/pm/PackageManagerService;
 
@@ -21430,7 +21486,7 @@
     :cond_f
     if-eqz v17, :cond_10
 
-    move/from16 v4, v19
+    move/from16 v5, v19
 
     goto :goto_c
 
@@ -21439,12 +21495,12 @@
 
     move-result v1
 
-    move v4, v1
+    move v5, v1
 
     :goto_c
     if-nez v17, :cond_12
 
-    if-eqz v4, :cond_11
+    if-eqz v5, :cond_11
 
     invoke-virtual/range {p0 .. p1}, Lcom/android/server/pm/InstallPackageHelper;->canSkipForcedPackageVerification(Lcom/android/server/pm/pkg/AndroidPackage;)Z
 
@@ -21455,32 +21511,48 @@
     goto :goto_d
 
     :cond_11
-    move/from16 v5, v16
+    move/from16 v6, v16
 
     goto :goto_e
 
     :cond_12
     :goto_d
-    move v5, v8
+    move v6, v8
 
     :goto_e
     iget-object v1, v0, Lcom/android/server/pm/InstallPackageHelper;->mPm:Lcom/android/server/pm/PackageManagerService;
 
-    invoke-virtual {v1, v15}, Lcom/android/server/pm/PackageManagerService;->getSettingsVersionForPackage(Lcom/android/server/pm/pkg/AndroidPackage;)Lcom/android/server/pm/Settings$VersionInfo;
+    invoke-virtual {v1}, Lcom/android/server/pm/PackageManagerService;->getPlatformPackage()Lcom/android/server/pm/pkg/AndroidPackage;
 
     move-result-object v3
 
     iget-object v1, v0, Lcom/android/server/pm/InstallPackageHelper;->mPm:Lcom/android/server/pm/PackageManagerService;
 
+    invoke-virtual {v1, v15}, Lcom/android/server/pm/PackageManagerService;->getSettingsVersionForPackage(Lcom/android/server/pm/pkg/AndroidPackage;)Lcom/android/server/pm/Settings$VersionInfo;
+
+    move-result-object v4
+
+    iget-object v1, v0, Lcom/android/server/pm/InstallPackageHelper;->mPm:Lcom/android/server/pm/PackageManagerService;
+
+    move/from16 v26, v7
+
     invoke-virtual {v1}, Lcom/android/server/pm/PackageManagerService;->isPreNMR1Upgrade()Z
 
-    move-result v6
+    move-result v7
+
+    move/from16 v27, v8
+
+    iget-object v8, v0, Lcom/android/server/pm/InstallPackageHelper;->mCustomPlatformSignatures:[Landroid/content/pm/Signature;
 
     move-object/from16 v1, v25
 
     move-object/from16 v2, p1
 
-    invoke-static/range {v1 .. v6}, Lcom/android/server/pm/ScanPackageUtils;->collectCertificatesLI(Lcom/android/server/pm/PackageSetting;Lcom/android/server/pm/parsing/pkg/ParsedPackage;Lcom/android/server/pm/Settings$VersionInfo;ZZZ)V
+    invoke-static/range {v1 .. v8}, Lcom/android/server/pm/ScanPackageUtils;->collectCertificatesLI(Lcom/android/server/pm/PackageSetting;Lcom/android/server/pm/parsing/pkg/ParsedPackage;Lcom/android/server/pm/pkg/AndroidPackage;Lcom/android/server/pm/Settings$VersionInfo;ZZZ[Landroid/content/pm/Signature;)V
+
+    move/from16 v7, v26
+
+    move/from16 v8, v27
 
     invoke-virtual {v0, v1, v15}, Lcom/android/server/pm/InstallPackageHelper;->maybeClearProfilesForUpgradesLI(Lcom/android/server/pm/PackageSetting;Lcom/android/server/pm/pkg/AndroidPackage;)V
 
diff --git a/smali_classes3/com/android/server/pm/ScanPackageUtils.smali b/smali_classes3/com/android/server/pm/ScanPackageUtils.smali
index b794bd23..7167f753 100644
--- a/smali_classes3/com/android/server/pm/ScanPackageUtils.smali
+++ b/smali_classes3/com/android/server/pm/ScanPackageUtils.smali
@@ -328,7 +328,7 @@
     return-object v0
 .end method
 
-.method public static applyPolicy(Lcom/android/server/pm/parsing/pkg/ParsedPackage;ILcom/android/server/pm/pkg/AndroidPackage;Z)V
+.method public static applyPolicy(Lcom/android/server/pm/parsing/pkg/ParsedPackage;ILcom/android/server/pm/pkg/AndroidPackage;Z[Landroid/content/pm/Signature;)V
     .locals 5
 
     const/high16 v0, 0x10000
@@ -522,29 +522,29 @@
     :goto_7
     invoke-interface {v3, p1}, Lcom/android/server/pm/parsing/pkg/ParsedPackage;->setOdm(Z)Lcom/android/server/pm/parsing/pkg/ParsedPackage;
 
-    const-string p1, "android"
+    invoke-interface {p0}, Lcom/android/server/pm/pkg/AndroidPackage;->getSigningDetails()Landroid/content/pm/SigningDetails;
 
-    invoke-interface {p0}, Lcom/android/server/pm/pkg/AndroidPackage;->getPackageName()Ljava/lang/String;
+    move-result-object p1
 
-    move-result-object v3
+    invoke-virtual {p1}, Landroid/content/pm/SigningDetails;->getSignatures()[Landroid/content/pm/Signature;
 
-    invoke-virtual {p1, v3}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    move-result-object p1
 
-    move-result p1
+    invoke-interface {p0}, Lcom/android/server/pm/pkg/AndroidPackage;->getPackageName()Ljava/lang/String;
 
-    if-nez p1, :cond_c
+    move-result-object v4
 
-    if-eqz p2, :cond_b
+    const-string v3, "android"
 
-    invoke-interface {p2}, Lcom/android/server/pm/pkg/AndroidPackage;->getSigningDetails()Landroid/content/pm/SigningDetails;
+    invoke-virtual {v3, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result-object p1
+    move-result v0
 
-    invoke-virtual {p1}, Landroid/content/pm/SigningDetails;->getSignatures()[Landroid/content/pm/Signature;
+    if-nez v0, :cond_d
 
-    move-result-object p1
+    if-eqz p2, :cond_b
 
-    invoke-interface {p0}, Lcom/android/server/pm/pkg/AndroidPackage;->getSigningDetails()Landroid/content/pm/SigningDetails;
+    invoke-interface {p2}, Lcom/android/server/pm/pkg/AndroidPackage;->getSigningDetails()Landroid/content/pm/SigningDetails;
 
     move-result-object p2
 
@@ -552,22 +552,29 @@
 
     move-result-object p2
 
-    invoke-static {p1, p2}, Lcom/android/server/pm/PackageManagerServiceUtils;->compareSignatures([Landroid/content/pm/Signature;[Landroid/content/pm/Signature;)I
+    invoke-static {p2, p1}, Lcom/android/server/pm/PackageManagerServiceUtils;->compareSignatures([Landroid/content/pm/Signature;[Landroid/content/pm/Signature;)I
+
+    move-result p2
+
+    if-eqz p2, :cond_d
+
+    :cond_b
+    invoke-static {p4, p1}, Lcom/android/server/pm/PackageManagerServiceUtils;->compareSignatures([Landroid/content/pm/Signature;[Landroid/content/pm/Signature;)I
 
     move-result p1
 
-    if-nez p1, :cond_b
+    if-nez p1, :cond_c
 
     goto :goto_8
 
-    :cond_b
+    :cond_c
     move v1, v2
 
-    :cond_c
+    :cond_d
     :goto_8
     invoke-interface {p0, v1}, Lcom/android/server/pm/parsing/pkg/ParsedPackage;->setSignedWithPlatformKey(Z)Lcom/android/server/pm/parsing/pkg/ParsedPackage;
 
-    if-nez v0, :cond_d
+    if-nez v0, :cond_e
 
     invoke-interface {p0}, Lcom/android/server/pm/parsing/pkg/ParsedPackage;->clearOriginalPackages()Lcom/android/server/pm/parsing/pkg/ParsedPackage;
 
@@ -575,7 +582,7 @@
 
     invoke-interface {p1}, Lcom/android/server/pm/parsing/pkg/ParsedPackage;->clearAdoptPermissions()Lcom/android/server/pm/parsing/pkg/ParsedPackage;
 
-    :cond_d
+    :cond_e
     invoke-static {p0, v0, p3}, Lcom/android/server/pm/parsing/library/PackageBackwardCompatibility;->modifySharedLibraries(Lcom/android/server/pm/parsing/pkg/ParsedPackage;ZZ)V
 
     return-void
@@ -1271,20 +1278,20 @@
     throw p0
 .end method
 
-.method public static collectCertificatesLI(Lcom/android/server/pm/PackageSetting;Lcom/android/server/pm/parsing/pkg/ParsedPackage;Lcom/android/server/pm/Settings$VersionInfo;ZZZ)V
+.method public static collectCertificatesLI(Lcom/android/server/pm/PackageSetting;Lcom/android/server/pm/parsing/pkg/ParsedPackage;Lcom/android/server/pm/pkg/AndroidPackage;Lcom/android/server/pm/Settings$VersionInfo;ZZZ[Landroid/content/pm/Signature;)V
     .locals 4
 
-    if-eqz p5, :cond_0
+    if-eqz p6, :cond_0
 
-    new-instance p5, Ljava/io/File;
+    new-instance p6, Ljava/io/File;
 
     invoke-interface {p1}, Lcom/android/server/pm/pkg/AndroidPackage;->getPath()Ljava/lang/String;
 
     move-result-object v0
 
-    invoke-direct {p5, v0}, Ljava/io/File;-><init>(Ljava/lang/String;)V
+    invoke-direct {p6, v0}, Ljava/io/File;-><init>(Ljava/lang/String;)V
 
-    invoke-virtual {p5}, Ljava/io/File;->lastModified()J
+    invoke-virtual {p6}, Ljava/io/File;->lastModified()J
 
     move-result-wide v0
 
@@ -1296,11 +1303,11 @@
     move-result-wide v0
 
     :goto_0
-    const-string p5, "PackageManager"
+    const-string p6, "PackageManager"
 
     if-eqz p0, :cond_2
 
-    if-nez p3, :cond_2
+    if-nez p4, :cond_2
 
     invoke-virtual {p0}, Lcom/android/server/pm/PackageSetting;->getPathString()Ljava/lang/String;
 
@@ -1324,49 +1331,49 @@
 
     if-nez v0, :cond_2
 
-    invoke-static {p2}, Lcom/android/server/pm/ReconcilePackageUtils;->isCompatSignatureUpdateNeeded(Lcom/android/server/pm/Settings$VersionInfo;)Z
+    invoke-static {p3}, Lcom/android/server/pm/ReconcilePackageUtils;->isCompatSignatureUpdateNeeded(Lcom/android/server/pm/Settings$VersionInfo;)Z
 
     move-result v0
 
     if-nez v0, :cond_2
 
-    invoke-static {p2}, Lcom/android/server/pm/ReconcilePackageUtils;->isRecoverSignatureUpdateNeeded(Lcom/android/server/pm/Settings$VersionInfo;)Z
+    invoke-static {p3}, Lcom/android/server/pm/ReconcilePackageUtils;->isRecoverSignatureUpdateNeeded(Lcom/android/server/pm/Settings$VersionInfo;)Z
 
-    move-result p2
+    move-result p3
 
-    if-nez p2, :cond_2
+    if-nez p3, :cond_2
 
     invoke-virtual {p0}, Lcom/android/server/pm/PackageSetting;->getSigningDetails()Landroid/content/pm/SigningDetails;
 
-    move-result-object p2
+    move-result-object p3
 
-    invoke-virtual {p2}, Landroid/content/pm/SigningDetails;->getSignatures()[Landroid/content/pm/Signature;
+    invoke-virtual {p3}, Landroid/content/pm/SigningDetails;->getSignatures()[Landroid/content/pm/Signature;
 
-    move-result-object p2
+    move-result-object p3
 
-    if-eqz p2, :cond_1
+    if-eqz p3, :cond_1
 
     invoke-virtual {p0}, Lcom/android/server/pm/PackageSetting;->getSigningDetails()Landroid/content/pm/SigningDetails;
 
-    move-result-object p2
+    move-result-object p3
 
-    invoke-virtual {p2}, Landroid/content/pm/SigningDetails;->getSignatures()[Landroid/content/pm/Signature;
+    invoke-virtual {p3}, Landroid/content/pm/SigningDetails;->getSignatures()[Landroid/content/pm/Signature;
 
-    move-result-object p2
+    move-result-object p3
 
-    array-length p2, p2
+    array-length p3, p3
 
-    if-eqz p2, :cond_1
+    if-eqz p3, :cond_1
 
     invoke-virtual {p0}, Lcom/android/server/pm/PackageSetting;->getSigningDetails()Landroid/content/pm/SigningDetails;
 
-    move-result-object p2
+    move-result-object p3
 
-    invoke-virtual {p2}, Landroid/content/pm/SigningDetails;->getSignatureSchemeVersion()I
+    invoke-virtual {p3}, Landroid/content/pm/SigningDetails;->getSignatureSchemeVersion()I
 
-    move-result p2
+    move-result p3
 
-    if-eqz p2, :cond_1
+    if-eqz p3, :cond_1
 
     new-instance p2, Landroid/content/pm/SigningDetails;
 
@@ -1381,127 +1388,178 @@
     return-void
 
     :cond_1
-    new-instance p2, Ljava/lang/StringBuilder;
+    new-instance p3, Ljava/lang/StringBuilder;
 
-    invoke-direct {p2}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {p3}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string p3, "PackageSetting for "
+    const-string p4, "PackageSetting for "
 
-    invoke-virtual {p2, p3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {p3, p4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
     invoke-virtual {p0}, Lcom/android/server/pm/PackageSetting;->getPackageName()Ljava/lang/String;
 
-    move-result-object p0
+    move-result-object p4
 
-    invoke-virtual {p2, p0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {p3, p4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    const-string p0, " is missing signatures.  Collecting certs again to recover them."
+    const-string p4, " is missing signatures.  Collecting certs again to recover them."
 
-    invoke-virtual {p2, p0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {p3, p4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {p2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {p3}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object p0
+    move-result-object p3
 
-    invoke-static {p5, p0}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {p6, p3}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
     goto :goto_2
 
     :cond_2
-    new-instance p0, Ljava/lang/StringBuilder;
+    new-instance p3, Ljava/lang/StringBuilder;
 
-    invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {p3}, Ljava/lang/StringBuilder;-><init>()V
 
     invoke-interface {p1}, Lcom/android/server/pm/pkg/AndroidPackage;->getPath()Ljava/lang/String;
 
-    move-result-object p2
+    move-result-object v0
 
-    invoke-virtual {p0, p2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {p3, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    const-string p2, " changed; collecting certs"
+    const-string v0, " changed; collecting certs"
 
-    invoke-virtual {p0, p2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {p3, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    if-eqz p3, :cond_3
+    if-eqz p4, :cond_3
 
-    const-string p2, " (forced)"
+    const-string p4, " (forced)"
 
     goto :goto_1
 
     :cond_3
-    const-string p2, ""
+    const-string p4, ""
 
     :goto_1
-    invoke-virtual {p0, p2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {p3, p4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {p3}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object p0
+    move-result-object p3
 
-    invoke-static {p5, p0}, Landroid/util/Slog;->i(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {p6, p3}, Landroid/util/Slog;->i(Ljava/lang/String;Ljava/lang/String;)I
 
     :goto_2
-    const-wide/32 p2, 0x40000
+    const-wide/32 p3, 0x40000
 
     :try_start_0
-    const-string p0, "collectCertificates"
+    const-string v0, "collectCertificates"
 
-    invoke-static {p2, p3, p0}, Landroid/os/Trace;->traceBegin(JLjava/lang/String;)V
+    invoke-static {p3, p4, v0}, Landroid/os/Trace;->traceBegin(JLjava/lang/String;)V
 
     invoke-static {}, Landroid/content/pm/parsing/result/ParseTypeImpl;->forDefaultParsing()Landroid/content/pm/parsing/result/ParseTypeImpl;
 
-    move-result-object p0
+    move-result-object v0
 
-    invoke-static {p0, p1, p4}, Lcom/android/server/pm/pkg/parsing/ParsingPackageUtils;->getSigningDetails(Landroid/content/pm/parsing/result/ParseInput;Lcom/android/server/pm/parsing/pkg/ParsedPackage;Z)Landroid/content/pm/parsing/result/ParseResult;
+    invoke-static {v0, p1, p5}, Lcom/android/server/pm/pkg/parsing/ParsingPackageUtils;->getSigningDetails(Landroid/content/pm/parsing/result/ParseInput;Lcom/android/server/pm/parsing/pkg/ParsedPackage;Z)Landroid/content/pm/parsing/result/ParseResult;
 
-    move-result-object p0
+    move-result-object p5
+
+    invoke-interface {p5}, Landroid/content/pm/parsing/result/ParseResult;->isError()Z
 
-    invoke-interface {p0}, Landroid/content/pm/parsing/result/ParseResult;->isError()Z
+    move-result v0
 
-    move-result p4
+    if-nez v0, :cond_5
 
-    if-nez p4, :cond_4
+    invoke-interface {p5}, Landroid/content/pm/parsing/result/ParseResult;->getResult()Ljava/lang/Object;
 
-    invoke-interface {p0}, Landroid/content/pm/parsing/result/ParseResult;->getResult()Ljava/lang/Object;
+    move-result-object v0
 
-    move-result-object p0
+    check-cast v0, Landroid/content/pm/SigningDetails;
 
-    check-cast p0, Landroid/content/pm/SigningDetails;
+    invoke-interface {p1, v0}, Lcom/android/server/pm/parsing/pkg/ParsedPackage;->setSigningDetails(Landroid/content/pm/SigningDetails;)Lcom/android/server/pm/parsing/pkg/ParsedPackage;
+
+    invoke-interface {p5}, Landroid/content/pm/parsing/result/ParseResult;->getResult()Ljava/lang/Object;
+
+    move-result-object p5
+
+    check-cast p5, Landroid/content/pm/SigningDetails;
+
+    invoke-virtual {p5}, Landroid/content/pm/SigningDetails;->getSignatures()[Landroid/content/pm/Signature;
+
+    move-result-object p5
+
+    invoke-static {p5, p7}, Lcom/android/server/pm/PackageManagerServiceUtils;->compareSignatures([Landroid/content/pm/Signature;[Landroid/content/pm/Signature;)I
+
+    move-result p5
+
+    if-nez p5, :cond_4
+
+    if-eqz p2, :cond_4
+
+    invoke-interface {p2}, Lcom/android/server/pm/pkg/AndroidPackage;->getSigningDetails()Landroid/content/pm/SigningDetails;
+
+    move-result-object v0
 
-    invoke-interface {p1, p0}, Lcom/android/server/pm/parsing/pkg/ParsedPackage;->setSigningDetails(Landroid/content/pm/SigningDetails;)Lcom/android/server/pm/parsing/pkg/ParsedPackage;
+    invoke-interface {p1, v0}, Lcom/android/server/pm/parsing/pkg/ParsedPackage;->setSigningDetails(Landroid/content/pm/SigningDetails;)Lcom/android/server/pm/parsing/pkg/ParsedPackage;
+
+    if-eqz p0, :cond_4
+
+    invoke-virtual {p0}, Lcom/android/server/pm/PackageSetting;->getAndroidPackage()Lcom/android/server/pm/pkg/AndroidPackage;
+
+    move-result-object v0
+
+    if-eqz v0, :cond_4
+
+    invoke-virtual {p0}, Lcom/android/server/pm/PackageSetting;->isPrivileged()Z
+
+    move-result v1
+
+    invoke-interface {v0}, Lcom/android/server/pm/pkg/AndroidPackage;->getTargetSdkVersion()I
+
+    move-result v2
+
+    invoke-static {v0, v1, v2}, Lcom/android/server/pm/SELinuxMMAC;->getSeInfo(Lcom/android/server/pm/pkg/AndroidPackage;ZI)Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-virtual {p0}, Lcom/android/server/pm/PackageSetting;->getTransientState()Lcom/android/server/pm/pkg/PackageStateUnserialized;
+
+    move-result-object p0
+
+    invoke-virtual {p0, v0}, Lcom/android/server/pm/pkg/PackageStateUnserialized;->setSeInfo(Ljava/lang/String;)Lcom/android/server/pm/pkg/PackageStateUnserialized;
     :try_end_0
     .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
-    invoke-static {p2, p3}, Landroid/os/Trace;->traceEnd(J)V
+    :cond_4
+    invoke-static {p3, p4}, Landroid/os/Trace;->traceEnd(J)V
 
     return-void
 
-    :cond_4
+    :cond_5
     :try_start_1
-    new-instance p1, Lcom/android/server/pm/PackageManagerException;
+    new-instance p0, Lcom/android/server/pm/PackageManagerException;
 
-    invoke-interface {p0}, Landroid/content/pm/parsing/result/ParseResult;->getErrorCode()I
+    invoke-interface {p5}, Landroid/content/pm/parsing/result/ParseResult;->getErrorCode()I
 
-    move-result p4
+    move-result p1
 
-    invoke-interface {p0}, Landroid/content/pm/parsing/result/ParseResult;->getErrorMessage()Ljava/lang/String;
+    invoke-interface {p5}, Landroid/content/pm/parsing/result/ParseResult;->getErrorMessage()Ljava/lang/String;
 
-    move-result-object p5
+    move-result-object p2
 
-    invoke-interface {p0}, Landroid/content/pm/parsing/result/ParseResult;->getException()Ljava/lang/Exception;
+    invoke-interface {p5}, Landroid/content/pm/parsing/result/ParseResult;->getException()Ljava/lang/Exception;
 
-    move-result-object p0
+    move-result-object p5
 
-    invoke-direct {p1, p4, p5, p0}, Lcom/android/server/pm/PackageManagerException;-><init>(ILjava/lang/String;Ljava/lang/Throwable;)V
+    invoke-direct {p0, p1, p2, p5}, Lcom/android/server/pm/PackageManagerException;-><init>(ILjava/lang/String;Ljava/lang/Throwable;)V
 
-    throw p1
+    throw p0
     :try_end_1
     .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     :catchall_0
     move-exception p0
 
-    invoke-static {p2, p3}, Landroid/os/Trace;->traceEnd(J)V
+    invoke-static {p3, p4}, Landroid/os/Trace;->traceEnd(J)V
 
     throw p0
 .end method
-- 
2.43.0

